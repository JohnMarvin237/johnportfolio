# Workflow Preview - Pull Request Deployments
name: Preview Deployment

on:
  pull_request:
    types: [opened, synchronize, reopened]

env:
  NODE_VERSION: '20.x'
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  preview:
    name: Deploy Preview
    runs-on: ubuntu-latest
    environment: preview
    permissions:
      contents: read
      pull-requests: write
      deployments: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Create GitHub Deployment
      uses: actions/github-script@v7
      id: deployment
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const deployment = await github.rest.repos.createDeployment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            ref: context.payload.pull_request.head.sha,
            environment: 'preview',
            description: 'PR Preview #' + context.issue.number,
            transient_environment: true,
            required_contexts: [],
            auto_merge: false
          });
          return deployment.data.id;

    - name: Install Vercel CLI
      run: npm install --global vercel@latest

    - name: Pull Vercel Environment Information
      run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}

    - name: Build Project Artifacts
      run: vercel build --token=${{ secrets.VERCEL_TOKEN }}
      env:
        NEXT_PUBLIC_IS_PREVIEW: true

    - name: Deploy to Vercel Preview
      id: deploy
      run: |
        deployment_url=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }})
        echo "deployment_url=$deployment_url" >> $GITHUB_OUTPUT
        echo "Preview URL: $deployment_url"

    - name: Update GitHub Deployment Status
      uses: actions/github-script@v7
      if: always()
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          await github.rest.repos.createDeploymentStatus({
            owner: context.repo.owner,
            repo: context.repo.repo,
            deployment_id: ${{ steps.deployment.outputs.result }},
            state: '${{ job.status }}' === 'success' ? 'success' : 'failure',
            environment_url: '${{ steps.deploy.outputs.deployment_url }}',
            description: 'Preview deployment ${{ job.status }}'
          });

    - name: Comment PR
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const comment = `### ðŸ” Preview Deployment

          **Status**: âœ… Success
          **Preview URL**: ${{ steps.deploy.outputs.deployment_url }}
          **Branch**: \`${{ github.event.pull_request.head.ref }}\`
          **Commit**: \`${{ github.event.pull_request.head.sha }}\`

          #### Lighthouse Scores (Preview)
          - ðŸŽ¯ Performance: _pending_
          - â™¿ Accessibility: _pending_
          - ðŸ“‹ Best Practices: _pending_
          - ðŸ” SEO: _pending_

          > ðŸ’¡ This is a preview deployment. It will be automatically deleted when the PR is closed.`;

          // Find existing comment
          const comments = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number
          });

          const botComment = comments.data.find(comment =>
            comment.user.type === 'Bot' &&
            comment.body.includes('Preview Deployment')
          );

          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: comment
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
          }

  preview-checks:
    name: Preview Checks
    runs-on: ubuntu-latest
    needs: preview
    if: success()

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Wait for deployment
      run: sleep 30

    - name: Run Lighthouse on Preview
      uses: treosh/lighthouse-ci-action@v10
      with:
        urls: |
          ${{ needs.preview.outputs.deployment_url }}/fr
          ${{ needs.preview.outputs.deployment_url }}/en
        uploadArtifacts: true
        temporaryPublicStorage: true
      continue-on-error: true